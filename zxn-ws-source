local RbxAnalyticsService = game:GetService("RbxAnalyticsService")
local HttpService = game:GetService("HttpService")

local SERVER_URL = "wss://api.zexon.workers.dev"

local userKey = _G.Key
local scriptId = _G.ScriptID or "1" -- Default to script "1" if they don't provide an ID

if not userKey or userKey == "" then
    warn("‚ùå Error: _G.Key is missing!")
    warn("Usage: _G.Key = 'YOUR_KEY_HERE'; loadstring(...)()")
    return -- Stop execution if no key is provided
end

local function getHwid()
    return RbxAnalyticsService:GetClientId()
end

print("üîÑ Connecting to Zexon Server...")

local success, ws = pcall(function()
    return WebSocket.connect(SERVER_URL)
end)

if not success or not ws then
    warn("‚ùå Connection Failed. Ensure your executor supports 'WebSocket.connect'.")
    return
end

ws.OnMessage:Connect(function(message)
    local response = HttpService:JSONDecode(message)

    if response.status == "success" then
        print("‚úÖ Authentication Successful!")
        print("‚è≥ Key Expires at:", os.date("%c", response.expiresAt / 1000))
        
        [cite_start]-- Close the socket to save resources [cite: 789]
        ws:Close()

        -- Run the protected script sent by the server
        local chunk, err = loadstring(response.script)
        if chunk then
            task.spawn(chunk)
        else
            warn("‚ö†Ô∏è Failed to compile received script:", err)
        end

    elseif response.status == "error" then
        warn("‚õî Authentication Failed:", response.message)
        ws:Close()
    end
end)

ws.OnClose:Connect(function()
    print("üîå Connection closed.")
end)

[cite_start]-- Send the key found in _G to the server [cite: 786]
local payload = {
    type = "auth",
    key = userKey,
    scriptId = tostring(scriptId),
    hwid = getHwid()
}

ws:Send(HttpService:JSONEncode(payload))
