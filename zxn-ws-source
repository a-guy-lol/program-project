-- [ Services ]
local RbxAnalyticsService = game:GetService("RbxAnalyticsService")
local HttpService = game:GetService("HttpService")

-- [ Configuration ]
local SERVER_URL = "wss://api.zexon.workers.dev" -- Your Worker URL
local SCRIPT_ID = "1" -- This matches the KV key "Script:1"

-- [ Authentication ]
-- Replace this with the key generated by your bot
local userKey = "YU2D0-P0XV2-F6PY2-QTIVU-N0WMH" 

-- [ Helper: Get HWID ]
local function getHwid()
    return RbxAnalyticsService:GetClientId()
end

print("Connecting to authentication server...")

-- [ WebSocket Connection ]
-- Using sUNC standard WebSocket.connect
local success, ws = pcall(function()
    return WebSocket.connect(SERVER_URL)
end)

if not success or not ws then
    warn("Failed to connect to WebSocket. Ensure your executor supports 'WebSocket.connect'.")
    return
end

-- [ Handle Messages ]
ws.OnMessage:Connect(function(message)
    -- Decode the JSON response from the worker
    local response = HttpService:JSONDecode(message)

    if response.status == "success" then
        print("✅ Authentication Successful!")
        print("Key Expires at timestamp:", response.expiresAt)
        
        -- Close the socket now that we have the script
        ws:Close()

        -- Execute the received script
        local chunk, err = loadstring(response.script)
        if chunk then
            task.spawn(chunk)
        else
            warn("Failed to compile script:", err)
        end

    elseif response.status == "error" then
        warn("❌ Authentication Failed:", response.message)
        ws:Close()
    end
end)

-- [ Handle Close ]
ws.OnClose:Connect(function()
    print("Connection closed.")
end)

-- [ Send Auth Request ]
local payload = {
    type = "auth",
    key = userKey,
    scriptId = SCRIPT_ID,
    hwid = getHwid()
}

ws:Send(HttpService:JSONEncode(payload))
