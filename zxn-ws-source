-- [ Services ]
local RbxAnalyticsService = game:GetService("RbxAnalyticsService")
local HttpService = game:GetService("HttpService")

-- [ Configuration ]
local SERVER_URL = "wss://api.zexon.workers.dev" -- Your Worker URL

-- [ 1. Read Global Configuration ]
local userKey = _G.Key
local scriptId = _G.ScriptID or "1" 

-- [ 2. Validation ]
if not userKey or userKey == "" then
    warn("‚ùå Error: _G.Key is missing!")
    return
end

-- [ Helper: Get HWID ]
local function getHwid()
    -- Safety check: ensure the service exists and returns a value
    local success, hwid = pcall(function()
        return RbxAnalyticsService:GetClientId()
    end)
    if success and hwid then
        return hwid
    end
    return "Unknown-HWID"
end

print("üîÑ Connecting to Server...")

-- [ 3. WebSocket Connection ]
if not getgenv().WebSocket then
    warn("‚ùå Error: Your executor does not support 'WebSocket' (sUNC standard).")
    return
end

local success, ws = pcall(function()
    return WebSocket.connect(SERVER_URL)
end)

if not success or not ws then
    warn("‚ùå Connection Failed:", ws)
    return
end

-- [ 4. Handle Messages ]
ws.OnMessage:Connect(function(message)
    -- Safety Check: Decode JSON safely
    local decodeSuccess, response = pcall(function()
        return HttpService:JSONDecode(message)
    end)

    if not decodeSuccess then
        warn("‚ùå Failed to decode server response.")
        return
    end

    if response.status == "success" then
        print("‚úÖ Authentication Successful!")
        
        -- FIXED: Check if expiresAt exists before doing math on it
        if response.expiresAt then
            print("‚è≥ Key Expires at:", os.date("%c", response.expiresAt / 1000))
        else
            print("‚è≥ Key Expires at: Never / Unknown")
        end
        
        ws:Close()

        -- FIXED: Check if script exists before loading
        if response.script and response.script ~= "" then
            local chunk, err = loadstring(response.script)
            if chunk then
                task.spawn(chunk)
            else
                warn("‚ö†Ô∏è Failed to compile received script:", err)
            end
        else
            warn("‚ö†Ô∏è Server responded with success, but no script was found.")
        end

    elseif response.status == "error" then
        warn("‚õî Authentication Failed:", response.message or "Unknown Error")
        ws:Close()
    end
end)

-- [ Handle Disconnection ]
ws.OnClose:Connect(function()
    print("üîå Connection closed.")
end)

-- [ 5. Send Authentication Payload ]
local payload = {
    type = "auth",
    key = userKey,
    scriptId = tostring(scriptId),
    hwid = getHwid()
}

ws:Send(HttpService:JSONEncode(payload))
